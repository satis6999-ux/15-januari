<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Mystery Box AJAIB4D</title>
<script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-gradient-to-br from-black via-gray-900 to-black min-h-screen">

<!-- ================== APP ================== -->
<div id="app" class="min-h-screen flex items-center justify-center p-6"></div>

<script>
/* ================== KONFIG ================== */
const WHATSAPP_NUMBER = '6287785520155';

/* ================== STATE ================== */
let stage = 'welcome';
let userId = '';
let hasSpun = false;

const SESSION_KEY = 'spin_session_lock';
let claimedUsers = JSON.parse(localStorage.getItem('claimedUsers')) || [];
let claimLogs = JSON.parse(localStorage.getItem('claimLogs')) || [];

/* ================== DATA ================== */
const prizes = [
  { value: 'Rp 200.000', icon: 'üí∏' },
  { value: 'Rp 500.000', icon: 'ü§ë' }
];

/* ================== UTIL ================== */
function formatUserId(input) {
  return input.toLowerCase().replace(/\s+/g,'').replace(/[^a-z0-9_*]/g,'');
}

function isValidUserId(id) {
  return /^(user|member|vip|player)_\*{3}\d{2}$/.test(id);
}

function lockSession() {
  if (localStorage.getItem(SESSION_KEY)) return false;
  localStorage.setItem(SESSION_KEY, 'LOCK');
  return true;
}

function unlockSession() {
  localStorage.removeItem(SESSION_KEY);
}

window.addEventListener('beforeunload', unlockSession);

/* ================== SAVE ================== */
function saveClaim(prize) {
  claimedUsers.push(userId);
  localStorage.setItem('claimedUsers', JSON.stringify(claimedUsers));

  const log = {
    userId,
    prize: prize.value,
    time: new Date().toISOString()
  };
  claimLogs.push(log);
  localStorage.setItem('claimLogs', JSON.stringify(claimLogs));
}

/* ================== UI ================== */
function renderWelcome() {
  return `
    <div class="text-center">
      <h1 class="text-5xl font-bold text-yellow-400 mb-6">üéÅ MYSTERY BOX</h1>
      <button id="startBtn"
        class="bg-yellow-500 hover:bg-yellow-400 px-10 py-4 rounded-xl text-black font-bold text-xl">
        SPIN SEKARANG
      </button>
    </div>
  `;
}

function renderInput() {
  return `
    <div class="bg-gray-900 p-8 rounded-2xl border-2 border-yellow-500 max-w-md w-full">
      <h2 class="text-yellow-400 text-2xl font-bold mb-4 text-center">Masukkan User ID</h2>

      <input id="userIdInput" class="w-full p-4 rounded mb-3 bg-black text-white"
        placeholder="contoh: user_***88">

      <div id="errorMsg" class="hidden text-red-400 text-sm mb-3"></div>

      <button id="continueBtn"
        class="w-full bg-yellow-500 py-3 rounded-xl font-bold text-black">
        Lanjut
      </button>
    </div>
  `;
}

function renderBoxes() {
  let boxes = '';
  for (let i=0;i<6;i++) {
    boxes += `<button class="box bg-yellow-500 rounded-xl p-6 text-4xl">üéÅ</button>`;
  }
  return `
    <div class="grid grid-cols-3 gap-4">
      ${boxes}
    </div>
  `;
}

function renderResult(prize) {
  return `
    <div class="bg-gray-900 p-8 rounded-2xl border-2 border-yellow-500 text-center max-w-md">
      <p class="text-gray-400 mb-2">User ID:</p>
      <p class="text-yellow-400 font-bold mb-4">${userId}</p>

      <div class="text-7xl mb-4">${prize.icon}</div>
      <div class="bg-yellow-500 text-black py-4 rounded-xl font-bold text-2xl mb-4">
        ${prize.value}
      </div>

      <button id="claimBtn"
        class="w-full bg-green-600 text-white py-3 rounded-xl mb-3">
        Klaim via WhatsApp
      </button>

      <button id="resetBtn"
        class="w-full bg-gray-700 text-white py-2 rounded-xl">
        Kembali
      </button>
    </div>
  `;
}

/* ================== RENDER ================== */
function render() {
  const app = document.getElementById('app');

  if (stage === 'welcome') {
    app.innerHTML = renderWelcome();
    document.getElementById('startBtn').onclick = () => {
      stage = 'input'; render();
    };
  }

  if (stage === 'input') {
    app.innerHTML = renderInput();
    document.getElementById('continueBtn').onclick = () => {
      const raw = document.getElementById('userIdInput').value;
      userId = formatUserId(raw);
      const err = document.getElementById('errorMsg');

      if (!userId) { err.textContent='User ID kosong'; err.classList.remove('hidden'); return; }
      if (!isValidUserId(userId)) { err.textContent='Format salah'; err.classList.remove('hidden'); return; }
      if (claimedUsers.includes(userId)) { err.textContent='User sudah klaim'; err.classList.remove('hidden'); return; }
      if (!lockSession()) { err.textContent='Sesi lain aktif'; err.classList.remove('hidden'); return; }

      stage = 'select'; render();
    };
  }

  if (stage === 'select') {
    app.innerHTML = renderBoxes();
    document.querySelectorAll('.box').forEach(btn => {
      btn.onclick = () => {
        if (hasSpun) return;
        hasSpun = true;

        const prize = prizes[Math.floor(Math.random()*prizes.length)];
        saveClaim(prize);

        stage = 'result';
        app.innerHTML = renderResult(prize);

        document.getElementById('claimBtn').onclick = () => {
          const payload = btoa(JSON.stringify({
            userId,
            prize: prize.value,
            time: new Date().toLocaleString()
          }));

          const msg = encodeURIComponent(
            `CLAIM HADIAH\nUser ID: ${userId}\nHadiah: ${prize.value}\nKode:\n${payload}`
          );

          window.open(`https://wa.me/${WHATSAPP_NUMBER}?text=${msg}`, '_blank');
        };

        document.getElementById('resetBtn').onclick = () => {
          unlockSession();
          hasSpun = false;
          userId = '';
          stage = 'welcome';
          render();
        };
      };
    });
  }
}

/* ================== START ================== */
render();
</script>

</body>
</html>
